<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Livestock Manager</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00bcd4">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%2300bcd4' width='200' height='200'/%3E%3Ctext x='100' y='130' text-anchor='middle' font-size='120' fill='white'%3Eüêê%3C/text%3E%3C/svg%3E">
    
    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.income {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .stat-card.expense {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .stat-card.profit {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .stat-card .value.positive {
            color: #2e7d32;
        }

        .stat-card .value.negative {
            color: #c62828;
        }

        .yearly-summary {
            margin-top: 20px;
        }

        .year-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .year-header {
            background: #f5f5f5;
            padding: 15px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .year-header:hover {
            background: #eeeeee;
        }

        .year-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #e0e0e0;
        }

        .year-stat {
            background: white;
            padding: 15px;
            text-align: center;
        }

        .year-stat .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .year-stat .amount {
            font-size: 20px;
            font-weight: bold;
        }

        .year-stat.income .amount {
            color: #2e7d32;
        }

        .year-stat.expense .amount {
            color: #c62828;
        }

        .year-stat.profit .amount.positive {
            color: #1565c0;
        }

        .year-stat.profit .amount.negative {
            color: #c62828;
        }

        .year-details {
            display: none;
            padding: 15px;
            background: #fafafa;
        }

        .year-details.expanded {
            display: block;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .transaction-item .date {
            color: #666;
            font-size: 12px;
        }

        .transaction-item .amount {
            font-weight: 600;
        }

        .transaction-item.income .amount {
            color: #2e7d32;
        }

        .transaction-item.expense .amount {
            color: #c62828;
        }

        .goat-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .goat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .goat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .goat-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #00bcd4;
        }

        .goat-card .info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .goat-card .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
            margin-top: 5px;
        }

        .tag.male {
            background: #e3f2fd;
            color: #1976d2;
        }

        .tag.female {
            background: #fce4ec;
            color: #c2185b;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 0;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            font-size: 22px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #555;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -20px;
            padding: 0 20px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .profile-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .profile-section:last-child {
            border-bottom: none;
        }

        .profile-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #00bcd4;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .profile-label {
            color: #666;
        }

        .profile-value {
            font-weight: 500;
            color: #333;
        }

        .profile-value.positive {
            color: #2e7d32;
        }

        .profile-value.negative {
            color: #c62828;
        }

        #calendar {
            max-width: 100%;
            margin: 20px 0;
        }

        .fc {
            font-size: 14px;
        }

        .fc-event {
            cursor: pointer;
        }

        .fc-event-completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .calendar-view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #00bcd4;
            background: white;
            color: #00bcd4;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #00bcd4;
            color: white;
        }

        .view-btn:hover {
            background: #00bcd4;
            color: white;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .year-stats {
                grid-template-columns: 1fr;
            }

            .goat-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px 15px;
                max-height: 90vh;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .table-wrapper {
                margin: 0 -15px;
                padding: 0 15px;
                position: relative;
            }

            .table-wrapper::after {
                content: '‚Üí';
                position: absolute;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                background: linear-gradient(to left, white 20%, transparent);
                padding: 10px 15px;
                pointer-events: none;
                font-size: 20px;
                color: #00bcd4;
            }

            table {
                font-size: 12px;
                min-width: 100%;
            }

            table th,
            table td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 10px;
                margin-right: 3px;
                margin-bottom: 3px;
                white-space: nowrap;
            }

            .container {
                padding: 15px;
            }

            .nav-tabs {
                padding: 3px;
            }

            .nav-tab {
                padding: 10px 12px;
                font-size: 13px;
            }

            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêê Livestock Manager</h1>
        <p>Track your herd, health, and finances</p>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('herd')">Herd</button>
            <button class="nav-tab" onclick="switchTab('health')">Health</button>
            <button class="nav-tab" onclick="switchTab('breeding')">Breeding</button>
            <button class="nav-tab" onclick="switchTab('schedule')">Schedule</button>
            <button class="nav-tab" onclick="switchTab('financial')">Financial</button>
            <button class="nav-tab" onclick="switchTab('data')">Data</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <h2>Herd Overview</h2>
                <div id="overviewStats"></div>
            </div>

            <div class="card">
                <h2>Financial Summary - All Time</h2>
                <div id="financialSummary"></div>
            </div>

            <div class="card">
                <h2>Yearly Breakdown</h2>
                <div id="yearlyBreakdown"></div>
            </div>
        </div>

        <!-- Herd Tab -->
        <div id="herd" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>My Herd</h2>
                    <button class="btn btn-primary" onclick="openAddGoatModal()">+ Add Goat</button>
                </div>
                <div id="herdList" class="goat-list"></div>
            </div>
        </div>

        <!-- Health Tab -->
        <div id="health" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>Health Records</h2>
                    <button class="btn btn-primary" onclick="openAddHealthModal()">+ Add Record</button>
                </div>
                <div id="healthRecordsList"></div>
            </div>
        </div>

        <!-- Breeding Tab -->
        <div id="breeding" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>Breeding Records</h2>
                    <button class="btn btn-primary" onclick="openAddBreedingModal()">+ Add Breeding</button>
                </div>
                <div id="breedingList"></div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>Schedule & Calendar</h2>
                    <button class="btn btn-primary" onclick="openAddTaskModal()">+ Add Task</button>
                </div>
                
                <div class="calendar-view-toggle">
                    <button class="view-btn active" onclick="toggleScheduleView('calendar')">üìÖ Calendar View</button>
                    <button class="view-btn" onclick="toggleScheduleView('list')">üìã List View</button>
                </div>

                <div id="calendarView" style="display: block;">
                    <div id="calendar"></div>
                </div>

                <div id="listView" style="display: none;">
                    <div id="scheduleList"></div>
                </div>
            </div>
        </div>

        <!-- Financial Tab -->
        <div id="financial" class="tab-content">
            <div class="card">
                <h2>Income & Expenses</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openAddIncomeModal()">+ Add Income</button>
                    <button class="btn btn-primary" onclick="openAddExpenseModal()">+ Add Expense</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card income">
                        <h3>Total Income</h3>
                        <div class="value positive" id="totalIncomeDisplay">$0.00</div>
                    </div>
                    <div class="stat-card expense">
                        <h3>Total Expenses</h3>
                        <div class="value negative" id="totalExpenseDisplay">$0.00</div>
                    </div>
                    <div class="stat-card profit">
                        <h3>Net Profit</h3>
                        <div class="value" id="netProfitDisplay">$0.00</div>
                    </div>
                </div>

                <div class="yearly-summary" id="yearlyFinancialBreakdown"></div>
            </div>
        </div>

        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="card">
                <h2>Export Data</h2>
                <p style="margin-bottom: 15px; color: #666;">Download your data as Excel or JSON backup</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportToExcel()">üìä Export to Excel</button>
                    <button class="btn btn-secondary" onclick="exportBackup()">üíæ Export JSON Backup</button>
                </div>
            </div>

            <div class="card">
                <h2>Import Data</h2>
                <p style="margin-bottom: 15px; color: #666;">Import from Excel or restore from JSON backup</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()">üìä Import from Excel</button>
                    <button class="btn btn-secondary" onclick="openImportModal()">üì• Import JSON Backup</button>
                </div>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
            </div>

            <div class="card">
                <h2>‚ö†Ô∏è Delete All Data</h2>
                <p style="margin-bottom: 15px; color: #c62828;">This will permanently delete all your data. This cannot be undone!</p>
                <button class="btn" style="background: #c62828; color: white;" onclick="deleteAllData()">Delete Everything</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addGoatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Goat</h2>
            </div>
            <form id="addGoatForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="goatName" required>
                </div>
                <div class="form-group">
                    <label>Sex *</label>
                    <select id="goatSex" required>
                        <option value="">Select...</option>
                        <option value="female">Doe (Female)</option>
                        <option value="male">Buck (Male)</option>
                        <option value="wether">Wether (Castrated Male)</option>
                        <option value="doe_kid">Doe Kid</option>
                        <option value="buck_kid">Buck Kid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tag/ID</label>
                    <input type="text" id="goatTag">
                </div>
                <div class="form-group">
                    <label>Breed</label>
                    <input type="text" id="goatBreed">
                </div>
                <div class="form-group">
                    <label>Birth Date</label>
                    <input type="date" id="goatBirthDate">
                </div>
                <div class="form-group">
                    <label>How Acquired</label>
                    <select id="goatAcquisition" onchange="togglePurchaseFields()">
                        <option value="born">Born on Farm</option>
                        <option value="purchased">Purchased</option>
                    </select>
                </div>
                <div id="bornFields" style="display: block;">
                    <div class="form-group">
                        <label>Dam (Mother)</label>
                        <select id="goatDam">
                            <option value="">Select dam...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sire (Father)</label>
                        <select id="goatSire">
                            <option value="">Select sire...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sire Name (if external)</label>
                        <input type="text" id="goatSireName" placeholder="e.g., Back in Black">
                        <small style="color: #666; font-size: 12px;">Use this if sire is not in your herd</small>
                    </div>
                </div>
                <div id="purchaseFields" style="display: none;">
                    <div class="form-group">
                        <label>Purchased From</label>
                        <input type="text" id="goatPurchasedFrom">
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="goatPurchaseDate">
                    </div>
                    <div class="form-group">
                        <label>Purchase Price ($)</label>
                        <input type="number" step="0.01" id="goatPurchasePrice">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="goatNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Goat</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addGoatModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addHealthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Health Record</h2>
            </div>
            <form id="addHealthForm">
                <div class="form-group">
                    <label>Goat *</label>
                    <select id="healthGoatId" required></select>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="healthType" required>
                        <option value="">Select...</option>
                        <option value="vaccination">Vaccination</option>
                        <option value="deworming">Deworming</option>
                        <option value="treatment">Treatment</option>
                        <option value="checkup">Checkup</option>
                        <option value="injury">Injury</option>
                        <option value="illness">Illness</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="healthDate" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="healthDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Cost ($)</label>
                    <input type="number" step="0.01" id="healthCost">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Record</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addHealthModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addBreedingModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Breeding Record</h2>
            </div>
            <form id="addBreedingForm">
                <div class="form-group">
                    <label>Doe (Recipient) *</label>
                    <select id="breedingDam" required></select>
                </div>
                
                <div class="form-group">
                    <label>Breeding Type *</label>
                    <select id="breedingType" required onchange="toggleBreedingFields()">
                        <option value="">Select...</option>
                        <option value="natural_internal">Natural - Internal Buck</option>
                        <option value="natural_external">Natural - External Buck</option>
                        <option value="ai">Artificial Insemination (AI)</option>
                        <option value="embryo">Embryo Recipient</option>
                    </select>
                </div>

                <!-- Internal Buck Field -->
                <div id="internalBuckField" style="display: none;">
                    <div class="form-group">
                        <label>Buck (Sire) *</label>
                        <select id="breedingSire"></select>
                    </div>
                </div>

                <!-- External Buck Field -->
                <div id="externalBuckField" style="display: none;">
                    <div class="form-group">
                        <label>External Buck Name *</label>
                        <input type="text" id="externalBuckName" placeholder="e.g., Back in Black">
                    </div>
                    <div class="form-group">
                        <label>Buck Owner/Location</label>
                        <input type="text" id="externalBuckLocation" placeholder="e.g., Smith Farm, John's Ranch">
                    </div>
                </div>

                <!-- AI Field -->
                <div id="aiField" style="display: none;">
                    <div class="form-group">
                        <label>Semen Source *</label>
                        <input type="text" id="semenSource" placeholder="e.g., Buck name/ID">
                    </div>
                    <div class="form-group">
                        <label>AI Performed By/Location</label>
                        <input type="text" id="aiLocation" placeholder="e.g., Vet clinic, technician name">
                    </div>
                </div>

                <!-- Embryo Fields -->
                <div id="embryoFields" style="display: none;">
                    <div class="form-group">
                        <label>Biological Dam *</label>
                        <select id="biologicalDam">
                            <option value="">Select biological dam...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Biological Sire *</label>
                        <select id="biologicalSire">
                            <option value="">Select biological sire...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Embryo Source/Notes</label>
                        <input type="text" id="embryoSource" placeholder="e.g., Clinic name, donor info">
                    </div>
                </div>

                <div class="form-group">
                    <label>Breeding Date *</label>
                    <input type="date" id="breedingDate" required onchange="calculateDueDate()">
                </div>
                
                <div class="form-group">
                    <label>Expected Kidding Date (auto-calculated at 150 days)</label>
                    <input type="date" id="breedingDueDate" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Ultrasound Date</label>
                    <input type="date" id="ultrasoundDate">
                </div>

                <div class="form-group">
                    <label>Ultrasound Result</label>
                    <select id="ultrasoundResult">
                        <option value="">Not done yet</option>
                        <option value="open">Open (not pregnant)</option>
                        <option value="1">1 kid</option>
                        <option value="2">2 kids</option>
                        <option value="3">3 kids</option>
                        <option value="4">4+ kids</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Actual Kidding Date</label>
                    <input type="date" id="actualKiddingDate">
                </div>

                <div class="form-group">
                    <label>Number of Kids Born</label>
                    <input type="number" id="numberOfKids" min="0" max="10">
                </div>

                <div class="form-group">
                    <label>Health Issues/Notes</label>
                    <textarea id="healthIssuesNotes" placeholder="Any complications, stillbirths, retained placenta, etc."></textarea>
                </div>

                <div class="form-group">
                    <label>General Notes</label>
                    <textarea id="breedingNotes" placeholder="Additional notes about this breeding"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Breeding</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addBreedingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editBreedingModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Breeding Record</h2>
            </div>
            <form id="editBreedingForm">
                <input type="hidden" id="editBreedingId">
                
                <div class="form-group">
                    <label>Doe (Recipient) *</label>
                    <select id="editBreedingDam" required></select>
                </div>
                
                <div class="form-group">
                    <label>Breeding Type *</label>
                    <select id="editBreedingType" required onchange="toggleEditBreedingFields()">
                        <option value="">Select...</option>
                        <option value="natural_internal">Natural - Internal Buck</option>
                        <option value="natural_external">Natural - External Buck</option>
                        <option value="ai">Artificial Insemination (AI)</option>
                        <option value="embryo">Embryo Recipient</option>
                    </select>
                </div>

                <!-- Internal Buck Field -->
                <div id="editInternalBuckField" style="display: none;">
                    <div class="form-group">
                        <label>Buck (Sire) *</label>
                        <select id="editBreedingSire"></select>
                    </div>
                </div>

                <!-- External Buck Field -->
                <div id="editExternalBuckField" style="display: none;">
                    <div class="form-group">
                        <label>External Buck Name *</label>
                        <input type="text" id="editExternalBuckName">
                    </div>
                    <div class="form-group">
                        <label>Buck Owner/Location</label>
                        <input type="text" id="editExternalBuckLocation" placeholder="e.g., Smith Farm, John's Ranch">
                    </div>
                </div>

                <!-- AI Field -->
                <div id="editAiField" style="display: none;">
                    <div class="form-group">
                        <label>Semen Source *</label>
                        <input type="text" id="editSemenSource">
                    </div>
                    <div class="form-group">
                        <label>AI Performed By/Location</label>
                        <input type="text" id="editAiLocation" placeholder="e.g., Vet clinic, technician name">
                    </div>
                </div>

                <!-- Embryo Fields -->
                <div id="editEmbryoFields" style="display: none;">
                    <div class="form-group">
                        <label>Biological Dam *</label>
                        <select id="editBiologicalDam">
                            <option value="">Select biological dam...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Biological Sire *</label>
                        <select id="editBiologicalSire">
                            <option value="">Select biological sire...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Embryo Source/Notes</label>
                        <input type="text" id="editEmbryoSource">
                    </div>
                </div>

                <div class="form-group">
                    <label>Breeding Date *</label>
                    <input type="date" id="editBreedingDate" required onchange="calculateEditDueDate()">
                </div>
                
                <div class="form-group">
                    <label>Expected Kidding Date (auto-calculated at 150 days)</label>
                    <input type="date" id="editBreedingDueDate" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label>Ultrasound Date</label>
                    <input type="date" id="editUltrasoundDate">
                </div>

                <div class="form-group">
                    <label>Ultrasound Result</label>
                    <select id="editUltrasoundResult">
                        <option value="">Not done yet</option>
                        <option value="open">Open (not pregnant)</option>
                        <option value="1">1 kid</option>
                        <option value="2">2 kids</option>
                        <option value="3">3 kids</option>
                        <option value="4">4+ kids</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Actual Kidding Date</label>
                    <input type="date" id="editActualKiddingDate">
                </div>

                <div class="form-group">
                    <label>Number of Kids Born</label>
                    <input type="number" id="editNumberOfKids" min="0" max="10">
                </div>

                <div class="form-group">
                    <label>Health Issues/Notes</label>
                    <textarea id="editHealthIssuesNotes"></textarea>
                </div>

                <div class="form-group">
                    <label>General Notes</label>
                    <textarea id="editBreedingNotes"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editBreedingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addKidsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add Kids from Breeding</h2>
            </div>
            <div id="addKidsContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Task</h2>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label>Goat</label>
                    <select id="taskGoatId">
                        <option value="">All Goats</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="taskType" required>
                        <option value="">Select...</option>
                        <option value="vaccination">Vaccination</option>
                        <option value="deworming">Deworming</option>
                        <option value="hoof-trim">Hoof Trim</option>
                        <option value="checkup">Checkup</option>
                        <option value="breeding">Breeding</option>
                        <option value="medication">Medication</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date *</label>
                    <input type="date" id="taskDueDate" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="taskDescription" required></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="taskRecurring" onchange="toggleRecurringFields()">
                        Make this a recurring task
                    </label>
                </div>

                <div id="recurringFields" style="display: none;">
                    <div class="form-group">
                        <label>Repeat Every *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="taskRecurInterval" min="1" value="1" style="width: 80px;">
                            <select id="taskRecurFrequency">
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>End Recurrence</label>
                        <select id="taskRecurEnd" onchange="toggleRecurEndDate()">
                            <option value="never">Never</option>
                            <option value="after">After number of occurrences</option>
                            <option value="on">On specific date</option>
                        </select>
                    </div>
                    <div id="recurAfterField" style="display: none;">
                        <div class="form-group">
                            <label>Number of Occurrences</label>
                            <input type="number" id="taskRecurCount" min="1" value="10">
                        </div>
                    </div>
                    <div id="recurOnField" style="display: none;">
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="taskRecurEndDate">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Task</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addIncomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Income</h2>
            </div>
            <form id="addIncomeForm">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="incomeDate" required>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="incomeType" required onchange="toggleIncomeGoatFields()">
                        <option value="">Select...</option>
                        <option value="animal-sale">Animal Sale</option>
                        <option value="milk">Milk Sales</option>
                        <option value="breeding-fee">Breeding Fee</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="incomeGoatFields" style="display: none;">
                    <div class="form-group">
                        <label>Related Goat</label>
                        <select id="incomeGoatId">
                            <option value="">Select goat...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Credit to Dam (if offspring sale)</label>
                        <select id="incomeCreditToDam">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Amount ($) *</label>
                    <input type="number" step="0.01" id="incomeAmount" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="incomeDescription" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Income</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addIncomeModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Expense</h2>
            </div>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="expenseType" required onchange="toggleExpenseGoatField()">
                        <option value="">Select...</option>
                        <option value="feed">Feed</option>
                        <option value="veterinary">Veterinary</option>
                        <option value="supplies">Supplies</option>
                        <option value="equipment">Equipment</option>
                        <option value="purchase">Animal Purchase</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div id="expenseGoatField" style="display: none;">
                    <div class="form-group">
                        <label>Related Goat</label>
                        <select id="expenseGoatId">
                            <option value="">All/General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Amount ($) *</label>
                    <input type="number" step="0.01" id="expenseAmount" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="expenseDescription" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addExpenseModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Backup</h2>
            </div>
            <p style="margin-bottom: 15px; color: #666;">Paste your JSON backup data below:</p>
            <textarea id="importData" style="width: 100%; min-height: 200px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="importBackup()">Import</button>
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="goatProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="profileGoatName"></h2>
            </div>
            <div id="profileContent"></div>
        </div>
    </div>

    <script>
        // Data storage
        let goats = [];
        let healthRecords = [];
        let scheduleTasks = [];
        let breedingRecords = [];
        let expenses = [];
        let income = [];
        let removedGoats = [];

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('livestockData');
            if (saved) {
                const data = JSON.parse(saved);
                goats = data.goats || [];
                healthRecords = data.healthRecords || [];
                scheduleTasks = data.scheduleTasks || [];
                breedingRecords = data.breedingRecords || [];
                expenses = data.expenses || [];
                income = data.income || [];
                removedGoats = data.removedGoats || [];
            }
        }

        // Save data to localStorage
        function saveData() {
            const data = {
                goats,
                healthRecords,
                scheduleTasks,
                breedingRecords,
                expenses,
                income,
                removedGoats
            };
            localStorage.setItem('livestockData', JSON.stringify(data));
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Render content for the tab
            if (tabName === 'overview') renderOverview();
            if (tabName === 'herd') renderHerd();
            if (tabName === 'health') renderHealthRecords();
            if (tabName === 'breeding') renderBreedingHistory();
            if (tabName === 'schedule') {
                renderSchedule();
                if (!window.calendar) {
                    initializeCalendar();
                } else {
                    renderCalendar();
                }
            }
            if (tabName === 'financial') renderFinancial();
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }

        function getAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function getAgeInMonths(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            return (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Toggle purchase fields
        function togglePurchaseFields() {
            const acquisition = document.getElementById('goatAcquisition').value;
            document.getElementById('purchaseFields').style.display = 
                acquisition === 'purchased' ? 'block' : 'none';
            document.getElementById('bornFields').style.display = 
                acquisition === 'born' ? 'block' : 'none';
        }

        function toggleIncomeGoatFields() {
            const type = document.getElementById('incomeType').value;
            document.getElementById('incomeGoatFields').style.display = 
                (type === 'animal-sale' || type === 'breeding-fee' || type === 'milk') ? 'block' : 'none';
        }

        function toggleExpenseGoatField() {
            const type = document.getElementById('expenseType').value;
            document.getElementById('expenseGoatField').style.display = 
                (type === 'veterinary' || type === 'purchase') ? 'block' : 'none';
        }

        // Add Goat
        function openAddGoatModal() {
            document.getElementById('addGoatForm').reset();
            document.getElementById('purchaseFields').style.display = 'none';
            document.getElementById('bornFields').style.display = 'block';
            
            // Populate dam dropdown
            const damSelect = document.getElementById('goatDam');
            damSelect.innerHTML = '<option value="">Select dam...</option>';
            goats.filter(g => g.sex === 'female' || g.sex === 'doe_kid').forEach(goat => {
                damSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            // Populate sire dropdown
            const sireSelect = document.getElementById('goatSire');
            sireSelect.innerHTML = '<option value="">Select sire...</option>';
            goats.filter(g => g.sex === 'male' || g.sex === 'buck_kid').forEach(goat => {
                sireSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            openModal('addGoatModal');
        }

        document.getElementById('addGoatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const goat = {
                id: generateId(),
                name: document.getElementById('goatName').value,
                sex: document.getElementById('goatSex').value,
                tag: document.getElementById('goatTag').value,
                breed: document.getElementById('goatBreed').value,
                birthDate: document.getElementById('goatBirthDate').value,
                acquisitionType: document.getElementById('goatAcquisition').value,
                notes: document.getElementById('goatNotes').value
            };

            if (goat.acquisitionType === 'born') {
                goat.dam = document.getElementById('goatDam').value || null;
                goat.sire = document.getElementById('goatSire').value || null;
                goat.sireName = document.getElementById('goatSireName').value || null;
            }

            if (goat.acquisitionType === 'purchased') {
                goat.purchasedFrom = document.getElementById('goatPurchasedFrom').value;
                goat.purchaseDate = document.getElementById('goatPurchaseDate').value;
                goat.purchasePrice = parseFloat(document.getElementById('goatPurchasePrice').value) || 0;

                // Add purchase as expense
                if (goat.purchasePrice > 0) {
                    expenses.push({
                        id: generateId(),
                        date: goat.purchaseDate || new Date().toISOString().split('T')[0],
                        type: 'purchase',
                        amount: goat.purchasePrice,
                        description: `Purchase of ${goat.name}` + (goat.purchasedFrom ? ` from ${goat.purchasedFrom}` : ''),
                        goatId: goat.id
                    });
                }
            }

            goats.push(goat);
            saveData();
            renderHerd();
            renderOverview();
            renderFinancial();
            closeModal('addGoatModal');
        });

        // Add Health Record
        function openAddHealthModal() {
            const select = document.getElementById('healthGoatId');
            select.innerHTML = '<option value="">Select goat...</option>';
            goats.forEach(goat => {
                select.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            document.getElementById('addHealthForm').reset();
            openModal('addHealthModal');
        }

        document.getElementById('addHealthForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const record = {
                id: generateId(),
                goatId: document.getElementById('healthGoatId').value,
                type: document.getElementById('healthType').value,
                date: document.getElementById('healthDate').value,
                description: document.getElementById('healthDescription').value
            };

            const cost = parseFloat(document.getElementById('healthCost').value);
            if (cost > 0) {
                expenses.push({
                    id: generateId(),
                    date: record.date,
                    type: 'veterinary',
                    amount: cost,
                    description: `${record.type}: ${record.description}`,
                    goatId: record.goatId
                });
            }

            healthRecords.push(record);
            saveData();
            renderHealthRecords();
            renderFinancial();
            closeModal('addHealthModal');
        });

        // Add Breeding
        function openAddBreedingModal() {
            const damSelect = document.getElementById('breedingDam');
            const sireSelect = document.getElementById('breedingSire');
            const biologicalDamSelect = document.getElementById('biologicalDam');
            const biologicalSireSelect = document.getElementById('biologicalSire');
            
            damSelect.innerHTML = '<option value="">Select doe...</option>';
            sireSelect.innerHTML = '<option value="">Select buck...</option>';
            biologicalDamSelect.innerHTML = '<option value="">Select biological dam...</option>';
            biologicalSireSelect.innerHTML = '<option value="">Select biological sire...</option>';
            
            // Populate does
            goats.filter(g => g.sex === 'female' || g.sex === 'doe_kid').forEach(goat => {
                damSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
                biologicalDamSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            // Populate bucks
            goats.filter(g => g.sex === 'male' || g.sex === 'buck_kid').forEach(goat => {
                sireSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
                biologicalSireSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            document.getElementById('addBreedingForm').reset();
            toggleBreedingFields(); // Reset field visibility
            openModal('addBreedingModal');
        }

        // Toggle breeding fields based on type
        function toggleBreedingFields() {
            const breedingType = document.getElementById('breedingType').value;
            
            // Hide all conditional fields
            document.getElementById('internalBuckField').style.display = 'none';
            document.getElementById('externalBuckField').style.display = 'none';
            document.getElementById('aiField').style.display = 'none';
            document.getElementById('embryoFields').style.display = 'none';
            
            // Show relevant fields based on type
            if (breedingType === 'natural_internal') {
                document.getElementById('internalBuckField').style.display = 'block';
                document.getElementById('breedingSire').required = true;
            } else if (breedingType === 'natural_external') {
                document.getElementById('externalBuckField').style.display = 'block';
                document.getElementById('externalBuckName').required = true;
            } else if (breedingType === 'ai') {
                document.getElementById('aiField').style.display = 'block';
                document.getElementById('semenSource').required = true;
            } else if (breedingType === 'embryo') {
                document.getElementById('embryoFields').style.display = 'block';
            }
        }

        // Auto-calculate due date (150 days from breeding)
        function calculateDueDate() {
            const breedingDate = document.getElementById('breedingDate').value;
            if (breedingDate) {
                const date = new Date(breedingDate);
                date.setDate(date.getDate() + 150);
                document.getElementById('breedingDueDate').value = date.toISOString().split('T')[0];
            }
        }

        document.getElementById('addBreedingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const breedingType = document.getElementById('breedingType').value;
            
            const record = {
                id: generateId(),
                damId: document.getElementById('breedingDam').value,
                breedingType: breedingType,
                breedingDate: document.getElementById('breedingDate').value,
                expectedKidding: document.getElementById('breedingDueDate').value,
                ultrasoundDate: document.getElementById('ultrasoundDate').value,
                ultrasoundResult: document.getElementById('ultrasoundResult').value,
                actualKidding: document.getElementById('actualKiddingDate').value,
                numberOfKids: document.getElementById('numberOfKids').value,
                healthIssuesNotes: document.getElementById('healthIssuesNotes').value,
                notes: document.getElementById('breedingNotes').value
            };

            // Add type-specific fields
            if (breedingType === 'natural_internal') {
                record.sireId = document.getElementById('breedingSire').value;
            } else if (breedingType === 'natural_external') {
                record.externalBuckName = document.getElementById('externalBuckName').value;
                record.externalBuckLocation = document.getElementById('externalBuckLocation').value;
            } else if (breedingType === 'ai') {
                record.semenSource = document.getElementById('semenSource').value;
                record.aiLocation = document.getElementById('aiLocation').value;
            } else if (breedingType === 'embryo') {
                record.biologicalDamId = document.getElementById('biologicalDam').value;
                record.biologicalSireId = document.getElementById('biologicalSire').value;
                record.embryoSource = document.getElementById('embryoSource').value;
            }

            breedingRecords.push(record);
            saveData();
            renderBreedingHistory();
            closeModal('addBreedingModal');
        });

        // Edit Breeding
        function openEditBreedingModal(breedingId) {
            const breeding = breedingRecords.find(b => b.id === breedingId);
            if (!breeding) return;

            // Populate selects
            const damSelect = document.getElementById('editBreedingDam');
            const sireSelect = document.getElementById('editBreedingSire');
            const biologicalDamSelect = document.getElementById('editBiologicalDam');
            const biologicalSireSelect = document.getElementById('editBiologicalSire');
            
            damSelect.innerHTML = '<option value="">Select doe...</option>';
            sireSelect.innerHTML = '<option value="">Select buck...</option>';
            biologicalDamSelect.innerHTML = '<option value="">Select biological dam...</option>';
            biologicalSireSelect.innerHTML = '<option value="">Select biological sire...</option>';
            
            goats.filter(g => g.sex === 'female' || g.sex === 'doe_kid').forEach(goat => {
                damSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
                biologicalDamSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            goats.filter(g => g.sex === 'male' || g.sex === 'buck_kid').forEach(goat => {
                sireSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
                biologicalSireSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });

            // Populate form with existing data
            document.getElementById('editBreedingId').value = breeding.id;
            document.getElementById('editBreedingDam').value = breeding.damId || '';
            document.getElementById('editBreedingType').value = breeding.breedingType || 'natural_internal';
            document.getElementById('editBreedingDate').value = breeding.breedingDate || '';
            document.getElementById('editBreedingDueDate').value = breeding.expectedKidding || breeding.dueDate || '';
            document.getElementById('editUltrasoundDate').value = breeding.ultrasoundDate || '';
            document.getElementById('editUltrasoundResult').value = breeding.ultrasoundResult || '';
            document.getElementById('editActualKiddingDate').value = breeding.actualKidding || '';
            document.getElementById('editNumberOfKids').value = breeding.numberOfKids || '';
            document.getElementById('editHealthIssuesNotes').value = breeding.healthIssuesNotes || '';
            document.getElementById('editBreedingNotes').value = breeding.notes || '';

            // Type-specific fields
            if (breeding.breedingType === 'natural_internal') {
                document.getElementById('editBreedingSire').value = breeding.sireId || '';
            } else if (breeding.breedingType === 'natural_external') {
                document.getElementById('editExternalBuckName').value = breeding.externalBuckName || '';
                document.getElementById('editExternalBuckLocation').value = breeding.externalBuckLocation || '';
            } else if (breeding.breedingType === 'ai') {
                document.getElementById('editSemenSource').value = breeding.semenSource || '';
                document.getElementById('editAiLocation').value = breeding.aiLocation || '';
            } else if (breeding.breedingType === 'embryo') {
                document.getElementById('editBiologicalDam').value = breeding.biologicalDamId || '';
                document.getElementById('editBiologicalSire').value = breeding.biologicalSireId || '';
                document.getElementById('editEmbryoSource').value = breeding.embryoSource || '';
            }

            toggleEditBreedingFields();
            openModal('editBreedingModal');
        }

        function toggleEditBreedingFields() {
            const breedingType = document.getElementById('editBreedingType').value;
            
            document.getElementById('editInternalBuckField').style.display = 'none';
            document.getElementById('editExternalBuckField').style.display = 'none';
            document.getElementById('editAiField').style.display = 'none';
            document.getElementById('editEmbryoFields').style.display = 'none';
            
            if (breedingType === 'natural_internal') {
                document.getElementById('editInternalBuckField').style.display = 'block';
            } else if (breedingType === 'natural_external') {
                document.getElementById('editExternalBuckField').style.display = 'block';
            } else if (breedingType === 'ai') {
                document.getElementById('editAiField').style.display = 'block';
            } else if (breedingType === 'embryo') {
                document.getElementById('editEmbryoFields').style.display = 'block';
            }
        }

        function calculateEditDueDate() {
            const breedingDate = document.getElementById('editBreedingDate').value;
            if (breedingDate) {
                const date = new Date(breedingDate);
                date.setDate(date.getDate() + 150);
                document.getElementById('editBreedingDueDate').value = date.toISOString().split('T')[0];
            }
        }

        document.getElementById('editBreedingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const breedingId = document.getElementById('editBreedingId').value;
            const breeding = breedingRecords.find(b => b.id === breedingId);
            if (!breeding) return;

            const breedingType = document.getElementById('editBreedingType').value;

            // Update all fields
            breeding.damId = document.getElementById('editBreedingDam').value;
            breeding.breedingType = breedingType;
            breeding.breedingDate = document.getElementById('editBreedingDate').value;
            breeding.expectedKidding = document.getElementById('editBreedingDueDate').value;
            breeding.ultrasoundDate = document.getElementById('editUltrasoundDate').value;
            breeding.ultrasoundResult = document.getElementById('editUltrasoundResult').value;
            breeding.actualKidding = document.getElementById('editActualKiddingDate').value;
            breeding.numberOfKids = document.getElementById('editNumberOfKids').value;
            breeding.healthIssuesNotes = document.getElementById('editHealthIssuesNotes').value;
            breeding.notes = document.getElementById('editBreedingNotes').value;

            // Clear type-specific fields
            delete breeding.sireId;
            delete breeding.externalBuckName;
            delete breeding.externalBuckLocation;
            delete breeding.semenSource;
            delete breeding.aiLocation;
            delete breeding.biologicalDamId;
            delete breeding.biologicalSireId;
            delete breeding.embryoSource;

            // Set type-specific fields
            if (breedingType === 'natural_internal') {
                breeding.sireId = document.getElementById('editBreedingSire').value;
            } else if (breedingType === 'natural_external') {
                breeding.externalBuckName = document.getElementById('editExternalBuckName').value;
                breeding.externalBuckLocation = document.getElementById('editExternalBuckLocation').value;
            } else if (breedingType === 'ai') {
                breeding.semenSource = document.getElementById('editSemenSource').value;
                breeding.aiLocation = document.getElementById('editAiLocation').value;
            } else if (breedingType === 'embryo') {
                breeding.biologicalDamId = document.getElementById('editBiologicalDam').value;
                breeding.biologicalSireId = document.getElementById('editBiologicalSire').value;
                breeding.embryoSource = document.getElementById('editEmbryoSource').value;
            }

            saveData();
            renderBreedingHistory();
            closeModal('editBreedingModal');
        });

        // Add Kids from Breeding
        function openAddKidsModal(breedingId) {
            const breeding = breedingRecords.find(b => b.id === breedingId);
            if (!breeding) return;

            const dam = goats.find(g => g.id === breeding.damId);
            const numberOfKids = parseInt(breeding.numberOfKids) || 0;

            let sireId = null;
            let sireName = null;

            // Determine sire based on breeding type
            if (breeding.breedingType === 'natural_internal') {
                sireId = breeding.sireId;
            } else if (breeding.breedingType === 'natural_external') {
                sireName = breeding.externalBuckName;
            } else if (breeding.breedingType === 'embryo') {
                sireId = breeding.biologicalSireId;
            }

            let html = `
                <p style="margin-bottom: 20px;">
                    <strong>Dam:</strong> ${dam ? dam.name : 'Unknown'}<br>
                    <strong>Kidding Date:</strong> ${formatDate(breeding.actualKidding)}<br>
                    <strong>Number of Kids:</strong> ${numberOfKids}
                </p>
                <form id="addKidsToHerdForm">
            `;

            for (let i = 1; i <= numberOfKids; i++) {
                html += `
                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; color: #00bcd4;">Kid #${i}</h3>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="kidName${i}" required>
                        </div>
                        <div class="form-group">
                            <label>Sex *</label>
                            <select id="kidSex${i}" required>
                                <option value="">Select...</option>
                                <option value="doe_kid">Doe Kid</option>
                                <option value="buck_kid">Buck Kid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tag/ID</label>
                            <input type="text" id="kidTag${i}">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="kidNotes${i}" placeholder="e.g., color, markings, nursing behavior"></textarea>
                        </div>
                    </div>
                `;
            }

            html += `
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add All Kids to Herd</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addKidsModal')">Cancel</button>
                    </div>
                </form>
            `;

            document.getElementById('addKidsContent').innerHTML = html;

            document.getElementById('addKidsToHerdForm').addEventListener('submit', function(e) {
                e.preventDefault();

                for (let i = 1; i <= numberOfKids; i++) {
                    const kid = {
                        id: generateId(),
                        name: document.getElementById(`kidName${i}`).value,
                        sex: document.getElementById(`kidSex${i}`).value,
                        tag: document.getElementById(`kidTag${i}`).value || '',
                        birthDate: breeding.actualKidding,
                        acquisitionType: 'born',
                        dam: breeding.damId,
                        sire: sireId,
                        sireName: sireName,
                        breed: dam ? dam.breed : '',
                        notes: document.getElementById(`kidNotes${i}`).value || ''
                    };

                    goats.push(kid);
                }

                saveData();
                renderHerd();
                renderOverview();
                closeModal('addKidsModal');
                alert(`‚úì Successfully added ${numberOfKids} kid${numberOfKids > 1 ? 's' : ''} to the herd!`);
            });

            openModal('addKidsModal');
        }

        // Add Task
        function openAddTaskModal() {
            const select = document.getElementById('taskGoatId');
            select.innerHTML = '<option value="">All Goats</option>';
            goats.forEach(goat => {
                select.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            document.getElementById('addTaskForm').reset();
            document.getElementById('recurringFields').style.display = 'none';
            document.getElementById('recurAfterField').style.display = 'none';
            document.getElementById('recurOnField').style.display = 'none';
            openModal('addTaskModal');
        }

        document.getElementById('addTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const task = {
                id: generateId(),
                goatId: document.getElementById('taskGoatId').value,
                type: document.getElementById('taskType').value,
                dueDate: document.getElementById('taskDueDate').value,
                description: document.getElementById('taskDescription').value,
                completed: false
            };

            // Add recurring fields if enabled
            if (document.getElementById('taskRecurring').checked) {
                task.recurring = true;
                task.recurInterval = parseInt(document.getElementById('taskRecurInterval').value) || 1;
                task.recurFrequency = document.getElementById('taskRecurFrequency').value;
                
                const endType = document.getElementById('taskRecurEnd').value;
                if (endType === 'after') {
                    task.recurCount = parseInt(document.getElementById('taskRecurCount').value);
                } else if (endType === 'on') {
                    task.recurEndDate = document.getElementById('taskRecurEndDate').value;
                }
            }

            scheduleTasks.push(task);
            saveData();
            renderSchedule();
            if (window.calendar) {
                renderCalendar();
            }
            closeModal('addTaskModal');
        });

        // Add Income
        function openAddIncomeModal() {
            const goatSelect = document.getElementById('incomeGoatId');
            const damSelect = document.getElementById('incomeCreditToDam');
            
            goatSelect.innerHTML = '<option value="">Select goat...</option>';
            damSelect.innerHTML = '<option value="">None</option>';
            
            goats.forEach(goat => {
                goatSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            goats.filter(g => g.sex === 'female').forEach(goat => {
                damSelect.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            
            document.getElementById('addIncomeForm').reset();
            document.getElementById('incomeGoatFields').style.display = 'none';
            openModal('addIncomeModal');
        }

        document.getElementById('addIncomeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const record = {
                id: generateId(),
                date: document.getElementById('incomeDate').value,
                type: document.getElementById('incomeType').value,
                amount: parseFloat(document.getElementById('incomeAmount').value),
                description: document.getElementById('incomeDescription').value,
                goatId: document.getElementById('incomeGoatId').value || null,
                creditedToDam: document.getElementById('incomeCreditToDam').value || null
            };

            income.push(record);
            saveData();
            renderFinancial();
            renderOverview();
            closeModal('addIncomeModal');
        });

        // Add Expense
        function openAddExpenseModal() {
            const select = document.getElementById('expenseGoatId');
            select.innerHTML = '<option value="">All/General</option>';
            goats.forEach(goat => {
                select.innerHTML += `<option value="${goat.id}">${goat.name}</option>`;
            });
            document.getElementById('addExpenseForm').reset();
            document.getElementById('expenseGoatField').style.display = 'none';
            openModal('addExpenseModal');
        }

        document.getElementById('addExpenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const record = {
                id: generateId(),
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value,
                goatId: document.getElementById('expenseGoatId').value || null
            };

            expenses.push(record);
            saveData();
            renderFinancial();
            renderOverview();
            closeModal('addExpenseModal');
        });

        // Render Overview
        function renderOverview() {
            const total = goats.length;
            const males = goats.filter(g => g.sex === 'male' || g.sex === 'buck_kid').length;
            const females = goats.filter(g => g.sex === 'female' || g.sex === 'doe_kid').length;

            const totalIncome = income.reduce((sum, i) => sum + i.amount, 0);
            const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalIncome - totalExpense;

            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Goats</h3>
                        <div class="value">${total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Males</h3>
                        <div class="value">${males}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Females</h3>
                        <div class="value">${females}</div>
                    </div>
                </div>
            `;

            document.getElementById('overviewStats').innerHTML = html;

            // Financial Summary
            let financialHtml = `
                <div class="stats-grid">
                    <div class="stat-card income">
                        <h3>Total Income</h3>
                        <div class="value positive">$${totalIncome.toFixed(2)}</div>
                    </div>
                    <div class="stat-card expense">
                        <h3>Total Expenses</h3>
                        <div class="value negative">$${totalExpense.toFixed(2)}</div>
                    </div>
                    <div class="stat-card profit">
                        <h3>Net Profit</h3>
                        <div class="value ${netProfit >= 0 ? 'positive' : 'negative'}">$${Math.abs(netProfit).toFixed(2)}</div>
                    </div>
                </div>
            `;

            document.getElementById('financialSummary').innerHTML = financialHtml;

            // Yearly Breakdown
            renderYearlyBreakdown();
        }

        // Render Yearly Breakdown
        function renderYearlyBreakdown() {
            const yearlyData = {};

            // Process income
            income.forEach(record => {
                const year = new Date(record.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expenses: 0, transactions: [] };
                }
                yearlyData[year].income += record.amount;
                yearlyData[year].transactions.push({
                    type: 'income',
                    date: record.date,
                    description: record.description,
                    amount: record.amount
                });
            });

            // Process expenses
            expenses.forEach(record => {
                const year = new Date(record.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expenses: 0, transactions: [] };
                }
                yearlyData[year].expenses += record.amount;
                yearlyData[year].transactions.push({
                    type: 'expense',
                    date: record.date,
                    description: record.description,
                    amount: record.amount
                });
            });

            // Sort years descending
            const years = Object.keys(yearlyData).sort((a, b) => b - a);

            let html = '';
            years.forEach(year => {
                const data = yearlyData[year];
                const profit = data.income - data.expenses;
                
                // Sort transactions by date descending
                data.transactions.sort((a, b) => b.date.localeCompare(a.date));

                html += `
                    <div class="year-section">
                        <div class="year-header" onclick="toggleYearDetails('${year}')">
                            <span>${year}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="year-stats">
                            <div class="year-stat income">
                                <div class="label">Income</div>
                                <div class="amount">$${data.income.toFixed(2)}</div>
                            </div>
                            <div class="year-stat expense">
                                <div class="label">Expenses</div>
                                <div class="amount">$${data.expenses.toFixed(2)}</div>
                            </div>
                            <div class="year-stat profit">
                                <div class="label">Profit</div>
                                <div class="amount ${profit >= 0 ? 'positive' : 'negative'}">$${Math.abs(profit).toFixed(2)}</div>
                            </div>
                        </div>
                        <div id="year-${year}" class="year-details">
                            <h4 style="margin-bottom: 10px; color: #555;">Transactions</h4>
                            <div class="transaction-list">
                `;

                data.transactions.forEach(t => {
                    html += `
                        <div class="transaction-item ${t.type}">
                            <div>
                                <div><strong>${t.description}</strong></div>
                                <div class="date">${formatDate(t.date)}</div>
                            </div>
                            <div class="amount">${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}</div>
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            if (years.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 20px;">No financial data yet</p>';
            }

            document.getElementById('yearlyBreakdown').innerHTML = html;
        }

        function toggleYearDetails(year) {
            const details = document.getElementById(`year-${year}`);
            details.classList.toggle('expanded');
        }

        // Render Herd
        function renderHerd() {
            let html = '';
            
            if (goats.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 40px;">No goats yet. Click "Add Goat" to get started!</p>';
            } else {
                goats.forEach(goat => {
                    const age = getAge(goat.birthDate);
                    const ageInMonths = getAgeInMonths(goat.birthDate);
                    const ageDisplay = age !== null ? 
                        (age === 0 ? `${ageInMonths}mo` : `${age}yr`) 
                        : '';
                    
                    const sexLabel = {
                        'female': 'Doe',
                        'male': 'Buck',
                        'wether': 'Wether',
                        'doe_kid': 'Doe Kid',
                        'buck_kid': 'Buck Kid'
                    }[goat.sex] || goat.sex;

                    html += `
                        <div class="goat-card" onclick="openGoatProfile('${goat.id}')">
                            <h3>${goat.name}</h3>
                            ${goat.tag ? `<div class="info">Tag: ${goat.tag}</div>` : ''}
                            ${goat.breed ? `<div class="info">${goat.breed}</div>` : ''}
                            ${ageDisplay ? `<div class="info">Age: ${ageDisplay}</div>` : ''}
                            <div style="margin-top: 8px;">
                                <span class="tag ${goat.sex === 'male' || goat.sex === 'buck_kid' ? 'male' : 'female'}">${sexLabel}</span>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('herdList').innerHTML = html;
        }

        // Render Health Records
        function renderHealthRecords() {
            if (healthRecords.length === 0) {
                document.getElementById('healthRecordsList').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 40px;">No health records yet</p>';
                return;
            }

            const sorted = [...healthRecords].sort((a, b) => b.date.localeCompare(a.date));

            let html = '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Goat</th><th>Type</th><th>Description</th></tr></thead><tbody>';
            
            sorted.forEach(record => {
                const goat = goats.find(g => g.id === record.goatId);
                html += `
                    <tr>
                        <td>${formatDate(record.date)}</td>
                        <td>${goat ? goat.name : 'Unknown'}</td>
                        <td>${record.type}</td>
                        <td>${record.description}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('healthRecordsList').innerHTML = html;
        }

        // Render Breeding History
        function renderBreedingHistory() {
            if (breedingRecords.length === 0) {
                document.getElementById('breedingList').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 40px;">No breeding records yet</p>';
                return;
            }

            const sorted = [...breedingRecords].sort((a, b) => b.breedingDate.localeCompare(a.breedingDate));

            let html = '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Doe</th><th>Type</th><th>Sire/Source</th><th>Expected</th><th>Actual</th><th>Result</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
            
            sorted.forEach(record => {
                const dam = goats.find(g => g.id === record.damId);
                
                // Determine sire/source display based on breeding type
                let sireDisplay = '';
                if (record.breedingType === 'natural_internal') {
                    const sire = goats.find(g => g.id === record.sireId);
                    sireDisplay = sire ? sire.name : 'Unknown';
                } else if (record.breedingType === 'natural_external') {
                    sireDisplay = record.externalBuckName || 'External';
                } else if (record.breedingType === 'ai') {
                    sireDisplay = record.semenSource || 'AI';
                } else if (record.breedingType === 'embryo') {
                    const bioDam = goats.find(g => g.id === record.biologicalDamId);
                    const bioSire = goats.find(g => g.id === record.biologicalSireId);
                    sireDisplay = `ET: ${bioDam ? bioDam.name : '?'} x ${bioSire ? bioSire.name : '?'}`;
                } else {
                    // Legacy records without type
                    const sire = goats.find(g => g.id === record.sireId);
                    sireDisplay = sire ? sire.name : 'Unknown';
                }

                // Breeding type display
                const typeLabels = {
                    'natural_internal': 'Natural (Internal)',
                    'natural_external': 'Natural (External)',
                    'ai': 'AI',
                    'embryo': 'Embryo'
                };
                const typeDisplay = typeLabels[record.breedingType] || 'Natural';

                // Result display
                let resultDisplay = '-';
                if (record.actualKidding) {
                    resultDisplay = record.numberOfKids ? `${record.numberOfKids} kid(s)` : 'Kidded';
                } else if (record.ultrasoundResult) {
                    if (record.ultrasoundResult === 'open') {
                        resultDisplay = '‚ùå Open';
                    } else {
                        resultDisplay = `${record.ultrasoundResult} (US)`;
                    }
                }

                // Action buttons
                let actions = `<button class="btn btn-primary action-btn" onclick="openEditBreedingModal('${record.id}')">Edit</button>`;
                if (record.actualKidding && record.numberOfKids > 0) {
                    actions += ` <button class="btn btn-secondary action-btn" onclick="openAddKidsModal('${record.id}')">Add Kids</button>`;
                }

                html += `
                    <tr>
                        <td>${formatDate(record.breedingDate)}</td>
                        <td>${dam ? dam.name : 'Unknown'}</td>
                        <td>${typeDisplay}</td>
                        <td>${sireDisplay}</td>
                        <td>${record.expectedKidding || record.dueDate ? formatDate(record.expectedKidding || record.dueDate) : '-'}</td>
                        <td>${record.actualKidding ? formatDate(record.actualKidding) : '-'}</td>
                        <td>${resultDisplay}</td>
                        <td>${record.notes || record.healthIssuesNotes || '-'}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('breedingList').innerHTML = html;
        }

        // Render Schedule
        function renderSchedule() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = scheduleTasks.filter(t => !t.completed).sort((a, b) => a.dueDate.localeCompare(b.dueDate));

            if (upcoming.length === 0) {
                document.getElementById('scheduleList').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 40px;">No upcoming tasks</p>';
                return;
            }

            let html = '<div class="table-wrapper"><table><thead><tr><th>Due Date</th><th>Goat</th><th>Type</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
            
            upcoming.forEach(task => {
                const goat = task.goatId ? goats.find(g => g.id === task.goatId) : null;
                const isOverdue = task.dueDate < today;
                const rowStyle = isOverdue ? 'style="background: #ffebee;"' : '';
                
                html += `
                    <tr ${rowStyle}>
                        <td>${formatDate(task.dueDate)} ${isOverdue ? '‚ö†Ô∏è' : ''}</td>
                        <td>${goat ? goat.name : 'All Goats'}</td>
                        <td>${task.type}</td>
                        <td>${task.description}</td>
                        <td>
                            <button class="btn btn-primary action-btn" onclick="completeTask('${task.id}')">Complete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('scheduleList').innerHTML = html;
        }

        function completeTask(taskId) {
            const task = scheduleTasks.find(t => t.id === taskId);
            if (task) {
                task.completed = true;
                task.completedDate = new Date().toISOString().split('T')[0];
                saveData();
                renderSchedule();
                if (window.calendar) {
                    renderCalendar();
                }
            }
        }

        // Toggle recurring fields in task modal
        function toggleRecurringFields() {
            const isRecurring = document.getElementById('taskRecurring').checked;
            document.getElementById('recurringFields').style.display = isRecurring ? 'block' : 'none';
        }

        function toggleRecurEndDate() {
            const endType = document.getElementById('taskRecurEnd').value;
            document.getElementById('recurAfterField').style.display = endType === 'after' ? 'block' : 'none';
            document.getElementById('recurOnField').style.display = endType === 'on' ? 'block' : 'none';
        }

        // Toggle between calendar and list view
        function toggleScheduleView(view) {
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            const buttons = document.querySelectorAll('.view-btn');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (view === 'calendar') {
                calendarView.style.display = 'block';
                listView.style.display = 'none';
                buttons[0].classList.add('active');
                if (window.calendar) {
                    window.calendar.render();
                } else {
                    initializeCalendar();
                }
            } else {
                calendarView.style.display = 'none';
                listView.style.display = 'block';
                buttons[1].classList.add('active');
            }
        }

        // Initialize Calendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            window.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek,listMonth'
                },
                events: getCalendarEvents(),
                eventClick: function(info) {
                    handleEventClick(info.event);
                },
                height: 'auto'
            });

            window.calendar.render();
        }

        // Get all events for calendar
        function getCalendarEvents() {
            const events = [];

            // Add scheduled tasks
            scheduleTasks.forEach(task => {
                const goat = task.goatId ? goats.find(g => g.id === task.goatId) : null;
                const isCompleted = task.completed;
                
                events.push({
                    id: `task-${task.id}`,
                    title: `${task.type.replace('-', ' ').toUpperCase()}: ${task.description}`,
                    start: task.dueDate,
                    backgroundColor: isCompleted ? '#9e9e9e' : getTaskColor(task.type),
                    borderColor: isCompleted ? '#757575' : getTaskColor(task.type),
                    extendedProps: {
                        type: 'task',
                        taskId: task.id,
                        goatName: goat ? goat.name : 'All Goats',
                        completed: isCompleted
                    },
                    classNames: isCompleted ? ['fc-event-completed'] : []
                });

                // If recurring, add future occurrences
                if (task.recurring && !isCompleted) {
                    const futureOccurrences = generateRecurringOccurrences(task, 6); // Next 6 months
                    futureOccurrences.forEach((date, idx) => {
                        events.push({
                            id: `task-${task.id}-recur-${idx}`,
                            title: `${task.type.replace('-', ' ').toUpperCase()}: ${task.description} (Recurring)`,
                            start: date,
                            backgroundColor: getTaskColor(task.type),
                            borderColor: getTaskColor(task.type),
                            extendedProps: {
                                type: 'recurring-task',
                                taskId: task.id,
                                goatName: goat ? goat.name : 'All Goats',
                                completed: false
                            }
                        });
                    });
                }
            });

            // Add breeding dates
            breedingRecords.forEach(breeding => {
                const dam = goats.find(g => g.id === breeding.damId);
                
                // Breeding date
                events.push({
                    id: `breeding-${breeding.id}`,
                    title: `üêê Bred: ${dam ? dam.name : 'Unknown'}`,
                    start: breeding.breedingDate,
                    backgroundColor: '#9c27b0',
                    borderColor: '#7b1fa2',
                    extendedProps: {
                        type: 'breeding',
                        breedingId: breeding.id
                    }
                });

                // Expected kidding date
                if (breeding.expectedKidding && !breeding.actualKidding) {
                    events.push({
                        id: `kidding-expected-${breeding.id}`,
                        title: `üìÖ Expected Kidding: ${dam ? dam.name : 'Unknown'}`,
                        start: breeding.expectedKidding,
                        backgroundColor: '#ff9800',
                        borderColor: '#f57c00',
                        extendedProps: {
                            type: 'expected-kidding',
                            breedingId: breeding.id
                        }
                    });
                }

                // Actual kidding date
                if (breeding.actualKidding) {
                    events.push({
                        id: `kidding-actual-${breeding.id}`,
                        title: `üéâ Kidded: ${dam ? dam.name : 'Unknown'} (${breeding.numberOfKids || '?'} kids)`,
                        start: breeding.actualKidding,
                        backgroundColor: '#4caf50',
                        borderColor: '#388e3c',
                        extendedProps: {
                            type: 'actual-kidding',
                            breedingId: breeding.id
                        }
                    });
                }

                // Ultrasound date
                if (breeding.ultrasoundDate) {
                    events.push({
                        id: `ultrasound-${breeding.id}`,
                        title: `üîç Ultrasound: ${dam ? dam.name : 'Unknown'}`,
                        start: breeding.ultrasoundDate,
                        backgroundColor: '#00bcd4',
                        borderColor: '#0097a7',
                        extendedProps: {
                            type: 'ultrasound',
                            breedingId: breeding.id
                        }
                    });
                }
            });

            return events;
        }

        // Get color for task type
        function getTaskColor(type) {
            const colors = {
                'vaccination': '#2196f3',
                'deworming': '#ff5722',
                'hoof-trim': '#795548',
                'checkup': '#00bcd4',
                'breeding': '#9c27b0',
                'medication': '#e91e63',
                'other': '#607d8b'
            };
            return colors[type] || '#607d8b';
        }

        // Generate recurring task occurrences
        function generateRecurringOccurrences(task, monthsAhead = 6) {
            if (!task.recurring) return [];
            
            const occurrences = [];
            const startDate = new Date(task.dueDate);
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + monthsAhead);

            let currentDate = new Date(startDate);
            const interval = task.recurInterval || 1;
            const frequency = task.recurFrequency || 'weeks';

            // Skip the first occurrence (it's already in the main task)
            addToDate(currentDate, interval, frequency);

            let count = 1;
            const maxCount = task.recurCount || 999;
            const recurEndDate = task.recurEndDate ? new Date(task.recurEndDate) : null;

            while (currentDate <= endDate && count < maxCount) {
                if (recurEndDate && currentDate > recurEndDate) break;
                
                occurrences.push(currentDate.toISOString().split('T')[0]);
                addToDate(currentDate, interval, frequency);
                count++;
            }

            return occurrences;
        }

        function addToDate(date, interval, frequency) {
            switch (frequency) {
                case 'days':
                    date.setDate(date.getDate() + interval);
                    break;
                case 'weeks':
                    date.setDate(date.getDate() + (interval * 7));
                    break;
                case 'months':
                    date.setMonth(date.getMonth() + interval);
                    break;
                case 'years':
                    date.setFullYear(date.getFullYear() + interval);
                    break;
            }
        }

        // Handle calendar event click
        function handleEventClick(event) {
            const props = event.extendedProps;
            
            if (props.type === 'task' || props.type === 'recurring-task') {
                const task = scheduleTasks.find(t => t.id === props.taskId);
                if (task) {
                    const msg = `${task.type.replace('-', ' ').toUpperCase()}
                    
Goat: ${props.goatName}
Due Date: ${formatDate(task.dueDate)}
Description: ${task.description}
Status: ${props.completed ? 'Completed ‚úì' : 'Pending'}`;

                    if (confirm(msg + '\n\nMark as complete?') && !props.completed) {
                        completeTask(task.id);
                    }
                }
            } else if (props.type === 'breeding' || props.type === 'expected-kidding' || props.type === 'actual-kidding' || props.type === 'ultrasound') {
                const breeding = breedingRecords.find(b => b.id === props.breedingId);
                if (breeding) {
                    openEditBreedingModal(breeding.id);
                }
            }
        }

        // Render calendar
        function renderCalendar() {
            if (window.calendar) {
                window.calendar.removeAllEvents();
                window.calendar.addEventSource(getCalendarEvents());
            }
        }

        // Render Financial
        function renderFinancial() {
            const totalIncome = income.reduce((sum, i) => sum + i.amount, 0);
            const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalIncome - totalExpense;

            document.getElementById('totalIncomeDisplay').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenseDisplay').textContent = `$${totalExpense.toFixed(2)}`;
            document.getElementById('netProfitDisplay').textContent = `$${Math.abs(netProfit).toFixed(2)}`;
            document.getElementById('netProfitDisplay').className = `value ${netProfit >= 0 ? 'positive' : 'negative'}`;

            renderYearlyFinancialBreakdown();
        }

        function renderYearlyFinancialBreakdown() {
            const yearlyData = {};

            // Process income
            income.forEach(record => {
                const year = new Date(record.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expenses: 0, transactions: [] };
                }
                yearlyData[year].income += record.amount;
                yearlyData[year].transactions.push({
                    type: 'income',
                    date: record.date,
                    description: record.description,
                    amount: record.amount
                });
            });

            // Process expenses
            expenses.forEach(record => {
                const year = new Date(record.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expenses: 0, transactions: [] };
                }
                yearlyData[year].expenses += record.amount;
                yearlyData[year].transactions.push({
                    type: 'expense',
                    date: record.date,
                    description: record.description,
                    amount: record.amount
                });
            });

            // Sort years descending
            const years = Object.keys(yearlyData).sort((a, b) => b - a);

            let html = '';
            years.forEach(year => {
                const data = yearlyData[year];
                const profit = data.income - data.expenses;
                
                // Sort transactions by date descending
                data.transactions.sort((a, b) => b.date.localeCompare(a.date));

                html += `
                    <div class="year-section">
                        <div class="year-header" onclick="toggleYearDetails('fin-${year}')">
                            <span>${year}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="year-stats">
                            <div class="year-stat income">
                                <div class="label">Income</div>
                                <div class="amount">$${data.income.toFixed(2)}</div>
                            </div>
                            <div class="year-stat expense">
                                <div class="label">Expenses</div>
                                <div class="amount">$${data.expenses.toFixed(2)}</div>
                            </div>
                            <div class="year-stat profit">
                                <div class="label">Profit</div>
                                <div class="amount ${profit >= 0 ? 'positive' : 'negative'}">$${Math.abs(profit).toFixed(2)}</div>
                            </div>
                        </div>
                        <div id="year-fin-${year}" class="year-details">
                            <h4 style="margin-bottom: 10px; color: #555;">Transactions (${data.transactions.length})</h4>
                            <div class="transaction-list">
                `;

                data.transactions.forEach(t => {
                    html += `
                        <div class="transaction-item ${t.type}">
                            <div>
                                <div><strong>${t.description}</strong></div>
                                <div class="date">${formatDate(t.date)}</div>
                            </div>
                            <div class="amount">${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}</div>
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            if (years.length === 0) {
                html = '<p style="text-align: center; color: #999; padding: 20px;">No financial data yet</p>';
            }

            document.getElementById('yearlyFinancialBreakdown').innerHTML = html;
        }

        // Export to Excel
        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Excel export library not loaded. Please refresh the page.');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Goats sheet
            const goatsData = goats.map(g => ({
                Name: g.name,
                Sex: g.sex,
                Tag: g.tag || '',
                Breed: g.breed || '',
                'Birth Date': g.birthDate || '',
                'Acquisition': g.acquisitionType || '',
                Notes: g.notes || ''
            }));
            const goatsSheet = XLSX.utils.json_to_sheet(goatsData);
            XLSX.utils.book_append_sheet(wb, goatsSheet, 'Goats');

            // Health Records sheet
            const healthData = healthRecords.map(h => {
                const goat = goats.find(g => g.id === h.goatId);
                return {
                    Date: h.date,
                    Goat: goat ? goat.name : '',
                    Type: h.type,
                    Description: h.description
                };
            });
            const healthSheet = XLSX.utils.json_to_sheet(healthData);
            XLSX.utils.book_append_sheet(wb, healthSheet, 'Health Records');

            // Financial sheet
            const financialData = [
                ...income.map(i => {
                    const goat = i.goatId ? goats.find(g => g.id === i.goatId) : null;
                    return {
                        Date: i.date,
                        Type: 'Income',
                        Category: i.type,
                        Amount: i.amount,
                        Description: i.description,
                        Goat: goat ? goat.name : ''
                    };
                }),
                ...expenses.map(e => {
                    const goat = e.goatId ? goats.find(g => g.id === e.goatId) : null;
                    return {
                        Date: e.date,
                        Type: 'Expense',
                        Category: e.type,
                        Amount: -e.amount,
                        Description: e.description,
                        Goat: goat ? goat.name : ''
                    };
                })
            ].sort((a, b) => b.Date.localeCompare(a.Date));
            
            const financialSheet = XLSX.utils.json_to_sheet(financialData);
            XLSX.utils.book_append_sheet(wb, financialSheet, 'Financial');

            XLSX.writeFile(wb, `livestock-data-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Backup functions
        function exportBackup() {
            const data = {
                goats,
                healthRecords,
                scheduleTasks,
                breedingRecords,
                expenses,
                income,
                removedGoats,
                exportDate: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `livestock-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function openImportModal() {
            document.getElementById('importData').value = '';
            openModal('importModal');
        }

        function importBackup() {
            try {
                const json = document.getElementById('importData').value;
                const backup = JSON.parse(json);

                if (!backup.goats && !backup.healthRecords && !backup.expenses && !backup.income) {
                    alert('Invalid backup file');
                    return;
                }

                if (!confirm('This will replace all current data. Continue?')) {
                    return;
                }

                goats = backup.goats || [];
                healthRecords = backup.healthRecords || [];
                scheduleTasks = backup.scheduleTasks || [];
                breedingRecords = backup.breedingRecords || [];
                expenses = backup.expenses || [];
                income = backup.income || [];
                removedGoats = backup.removedGoats || [];

                saveData();
                renderOverview();
                renderHerd();
                renderBreedingHistory();
                renderHealthRecords();
                renderSchedule();
                renderFinancial();

                alert('Import successful!');
                closeModal('importModal');
            } catch (error) {
                alert('Error importing data: ' + error.message);
            }
        }

        function deleteAllData() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL DATA permanently. This cannot be undone!\n\nAre you sure?')) {
                return;
            }

            if (!confirm('Are you ABSOLUTELY sure? All goats, health records, breeding records, and financial data will be lost forever!')) {
                return;
            }

            localStorage.removeItem('livestockData');
            goats = [];
            healthRecords = [];
            scheduleTasks = [];
            breedingRecords = [];
            expenses = [];
            income = [];
            removedGoats = [];

            renderOverview();
            renderHerd();
            renderBreedingHistory();
            renderHealthRecords();
            renderSchedule();
            renderFinancial();

            alert('All data has been deleted');
        }

        // Import from Excel
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                alert('Excel library not loaded. Please refresh the page and try again.');
                return;
            }

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);

                let importedGoats = [];
                let importedHealth = [];
                let importedBreeding = [];
                let importedExpenses = [];
                let importedIncome = [];
                let importedSchedule = [];
                let importedRemoved = [];

                // Import Goats
                if (workbook.SheetNames.includes('Goats')) {
                    const sheet = workbook.Sheets['Goats'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedGoats = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        name: row['Name'] || '',
                        tag: row['Tag/ID'] || '',
                        sex: row['Sex'] || '',
                        birthDate: row['Birth Date'] ? excelDateToISO(row['Birth Date']) : '',
                        breed: row['Breed'] || '',
                        acquisitionType: row['Acquisition Type'] || 'born',
                        dam: row['Dam ID'] || null,
                        sire: row['Sire ID'] || null,
                        sireName: row['Sire Name'] || null,
                        damName: row['Dam Name'] || null,
                        purchasePrice: row['Purchase Price'] || 0,
                        purchaseDate: row['Purchase Date'] ? excelDateToISO(row['Purchase Date']) : '',
                        purchasedFrom: row['Purchased From'] || '',
                        notes: row['Notes'] || ''
                    })).filter(g => g.name); // Only include rows with names
                }

                // Import Health Records
                if (workbook.SheetNames.includes('Health Records')) {
                    const sheet = workbook.Sheets['Health Records'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedHealth = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        goatId: row['Goat ID'] || '',
                        type: row['Type'] || 'checkup',
                        date: row['Date'] ? excelDateToISO(row['Date']) : new Date().toISOString().split('T')[0],
                        description: row['Description'] || ''
                    })).filter(h => h.goatId && h.description);
                }

                // Import Schedule
                if (workbook.SheetNames.includes('Schedule')) {
                    const sheet = workbook.Sheets['Schedule'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedSchedule = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        goatId: row['Goat ID'] || '',
                        type: row['Type'] || 'other',
                        dueDate: row['Due Date'] ? excelDateToISO(row['Due Date']) : '',
                        description: row['Description'] || '',
                        completed: row['Completed'] === 'Yes' || row['Completed'] === true || false
                    })).filter(t => t.description && t.dueDate);
                }

                // Import Breeding
                if (workbook.SheetNames.includes('Breeding')) {
                    const sheet = workbook.Sheets['Breeding'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedBreeding = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        damId: row['Doe ID'] || '',
                        breedingType: row['Breeding Type'] || 'natural_internal',
                        sireId: row['Buck ID'] || '',
                        externalBuckName: row['External Buck Name'] || '',
                        semenSource: row['Semen Source'] || '',
                        biologicalDamId: row['Biological Dam ID'] || '',
                        biologicalSireId: row['Biological Sire ID'] || '',
                        embryoSource: row['Embryo Source'] || '',
                        breedingDate: row['Breeding Date'] ? excelDateToISO(row['Breeding Date']) : '',
                        expectedKidding: row['Expected Kidding'] ? excelDateToISO(row['Expected Kidding']) : '',
                        ultrasoundDate: row['Ultrasound Date'] ? excelDateToISO(row['Ultrasound Date']) : '',
                        ultrasoundResult: row['Ultrasound Result'] || '',
                        actualKidding: row['Actual Kidding'] ? excelDateToISO(row['Actual Kidding']) : '',
                        numberOfKids: row['Number of Kids'] || '',
                        healthIssuesNotes: row['Health Issues Notes'] || '',
                        notes: row['General Notes'] || '',
                        // Support legacy 'dueDate' field
                        dueDate: row['Expected Kidding'] ? excelDateToISO(row['Expected Kidding']) : ''
                    })).filter(b => b.damId && b.breedingDate);
                }

                // Import Expenses
                if (workbook.SheetNames.includes('Expenses')) {
                    const sheet = workbook.Sheets['Expenses'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedExpenses = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        goatId: row['Goat ID'] || null,
                        type: row['Category'] || 'other',
                        amount: parseFloat(row['Amount']) || 0,
                        date: row['Date'] ? excelDateToISO(row['Date']) : '',
                        description: row['Description'] || ''
                    })).filter(e => e.amount > 0 && e.description);
                }

                // Import Income
                if (workbook.SheetNames.includes('Income')) {
                    const sheet = workbook.Sheets['Income'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedIncome = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        goatId: row['Goat ID'] || null,
                        type: row['Category'] || 'other',
                        amount: parseFloat(row['Amount']) || 0,
                        date: row['Date'] ? excelDateToISO(row['Date']) : '',
                        description: row['Description'] || '',
                        creditedToDam: row['Credited To Dam'] || null
                    })).filter(i => i.amount > 0 && i.description);
                }

                // Import Removed Goats
                if (workbook.SheetNames.includes('Removed Goats')) {
                    const sheet = workbook.Sheets['Removed Goats'];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    importedRemoved = rows.map(row => ({
                        id: row['ID'] || generateId(),
                        name: row['Name'] || '',
                        sex: row['Sex'] || '',
                        removalDate: row['Removal Date'] ? excelDateToISO(row['Removal Date']) : '',
                        removalReason: row['Removal Reason'] || '',
                        dam: row['Dam ID'] || null,
                        sire: row['Sire ID'] || null
                    })).filter(r => r.name);
                }

                // Show confirmation dialog
                const confirmMsg = `Import the following data from Excel?\n\n` +
                    `‚Ä¢ ${importedGoats.length} goats\n` +
                    `‚Ä¢ ${importedHealth.length} health records\n` +
                    `‚Ä¢ ${importedBreeding.length} breeding records\n` +
                    `‚Ä¢ ${importedSchedule.length} scheduled tasks\n` +
                    `‚Ä¢ ${importedExpenses.length} expenses\n` +
                    `‚Ä¢ ${importedIncome.length} income records\n` +
                    `‚Ä¢ ${importedRemoved.length} removed goats\n\n` +
                    `This will ADD to your existing data (not replace).`;

                if (!confirm(confirmMsg)) {
                    event.target.value = ''; // Reset file input
                    return;
                }

                // Add imported data to existing data
                goats.push(...importedGoats);
                healthRecords.push(...importedHealth);
                breedingRecords.push(...importedBreeding);
                scheduleTasks.push(...importedSchedule);
                expenses.push(...importedExpenses);
                income.push(...importedIncome);
                removedGoats.push(...importedRemoved);

                // Save and refresh
                saveData();
                renderOverview();
                renderHerd();
                renderBreedingHistory();
                renderHealthRecords();
                renderSchedule();
                renderFinancial();

                alert(`‚úì Import successful!\n\n` +
                    `Imported:\n` +
                    `‚Ä¢ ${importedGoats.length} goats\n` +
                    `‚Ä¢ ${importedHealth.length} health records\n` +
                    `‚Ä¢ ${importedBreeding.length} breeding records\n` +
                    `‚Ä¢ ${importedSchedule.length} scheduled tasks\n` +
                    `‚Ä¢ ${importedExpenses.length} expenses\n` +
                    `‚Ä¢ ${importedIncome.length} income records\n` +
                    `‚Ä¢ ${importedRemoved.length} removed goats`);

                event.target.value = ''; // Reset file input

            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Error importing Excel file:\n\n' + error.message + '\n\nPlease make sure the file format is correct.');
                event.target.value = ''; // Reset file input
            }
        }

        // Helper function to convert Excel date serial number to ISO date
        function excelDateToISO(excelDate) {
            if (typeof excelDate === 'string') {
                // Already a string, might be ISO format
                if (excelDate.includes('-')) return excelDate;
                // Try to parse as date string
                const parsed = new Date(excelDate);
                if (!isNaN(parsed)) {
                    return parsed.toISOString().split('T')[0];
                }
                return excelDate;
            }
            
            if (typeof excelDate === 'number') {
                // Excel date serial number (days since 1900-01-01)
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            if (excelDate instanceof Date) {
                return excelDate.toISOString().split('T')[0];
            }
            
            return '';
        }

        // Goat Profile
        function openGoatProfile(goatId) {
            const goat = goats.find(g => g.id === goatId);
            if (!goat) return;

            document.getElementById('profileGoatName').textContent = goat.name;

            const age = goat.birthDate ? getAge(goat.birthDate) : null;
            const ageInMonths = goat.birthDate ? getAgeInMonths(goat.birthDate) : null;
            const ageDisplay = age !== null ? 
                (age === 0 ? `${ageInMonths} month${ageInMonths !== 1 ? 's' : ''}` : `${age} year${age !== 1 ? 's' : ''}`) 
                : 'Unknown';

            const goatExpenses = expenses.filter(e => e.goatId === goatId);
            const goatIncome = income.filter(i => i.goatId === goatId || i.creditedToDam === goatId);
            const totalExpense = goatExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalIncome = goatIncome.reduce((sum, i) => sum + i.amount, 0);
            const profit = totalIncome - totalExpense;

            const goatHealthRecords = healthRecords.filter(h => h.goatId === goatId).sort((a, b) => b.date.localeCompare(a.date));
            const recentHealth = goatHealthRecords.slice(0, 3);

            const sexLabel = {
                'female': 'Doe',
                'male': 'Buck',
                'wether': 'Wether',
                'doe_kid': 'Doe Kid',
                'buck_kid': 'Buck Kid'
            }[goat.sex] || goat.sex;

            let html = '';

            html += '<div class="profile-section">';
            html += '<h3>Basic Information</h3>';
            html += `<div class="profile-row"><span class="profile-label">Sex:</span><span class="profile-value">${sexLabel}</span></div>`;
            if (goat.tag) html += `<div class="profile-row"><span class="profile-label">Tag/ID:</span><span class="profile-value">${goat.tag}</span></div>`;
            if (goat.breed) html += `<div class="profile-row"><span class="profile-label">Breed:</span><span class="profile-value">${goat.breed}</span></div>`;
            if (goat.birthDate) {
                html += `<div class="profile-row"><span class="profile-label">Birth Date:</span><span class="profile-value">${formatDate(goat.birthDate)}</span></div>`;
                html += `<div class="profile-row"><span class="profile-label">Age:</span><span class="profile-value">${ageDisplay}</span></div>`;
            }
            html += '</div>';

            html += '<div class="profile-section">';
            html += '<h3>Financial Summary</h3>';
            html += `<div class="profile-row"><span class="profile-label">Total Income:</span><span class="profile-value positive">$${totalIncome.toFixed(2)}</span></div>`;
            html += `<div class="profile-row"><span class="profile-label">Total Expenses:</span><span class="profile-value negative">$${totalExpense.toFixed(2)}</span></div>`;
            html += `<div class="profile-row"><span class="profile-label">Net Profit/Loss:</span><span class="profile-value ${profit >= 0 ? 'positive' : 'negative'}">$${Math.abs(profit).toFixed(2)}</span></div>`;
            html += '</div>';

            html += '<div class="profile-section">';
            html += '<h3>Health Status</h3>';
            if (recentHealth.length > 0) {
                html += '<div style="font-size: 13px;"><strong>Recent Health Records:</strong></div>';
                recentHealth.forEach(record => {
                    html += `<div style="margin: 8px 0; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 13px;">`;
                    html += `<strong>${record.type.replace('-', ' ').toUpperCase()}</strong> - ${formatDate(record.date)}<br>`;
                    html += `${record.description}`;
                    html += `</div>`;
                });
            } else {
                html += '<p style="color: #999; font-size: 13px;">No health records</p>';
            }
            html += '</div>';

            if (goat.notes) {
                html += '<div class="profile-section">';
                html += '<h3>Notes</h3>';
                html += `<p style="font-size: 13px; line-height: 1.5; white-space: pre-wrap;">${goat.notes}</p>`;
                html += '</div>';
            }

            html += '<div style="margin-top: 20px;">';
            html += `<button class="btn btn-secondary" onclick="closeModal('goatProfileModal')">Close</button>`;
            html += '</div>';

            document.getElementById('profileContent').innerHTML = html;
            openModal('goatProfileModal');
        }

        // Initialize
        loadData();
        renderOverview();
        renderHerd();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
